<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Most Used Words in the Bible (KJV)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: auto;
        }
        #filters {
            margin-bottom: 20px;
            text-align: center;
        }
        #filters label {
            margin-right: 10px;
        }
        #filters select, #filters input {
            margin: 5px;
            padding: 5px;
        }
        #filters button {
            padding: 5px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        #filters button:hover {
            background-color: #0056b3;
        }
        #word-cloud {
            text-align: center;
            max-width: 90%;
            flex-wrap: wrap;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .word {
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s;
            padding: 5px;
        }
        .word:hover {
            transform: scale(1.1);
            color: #007BFF;
        }
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            text-align: left;
        }
        #popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #333;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        #error-message {
            color: red;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="filters">
        <label for="book-select">Book:</label>
        <select id="book-select">
            <option value="all">All Books</option>
            <!-- Options will be populated dynamically -->
        </select>
        <br>
        <label for="include-words">Include Words (comma-separated):</label>
        <input type="text" id="include-words" placeholder="e.g., lord, god">
        <br>
        <label for="exclude-words">Exclude Words (comma-separated):</label>
        <input type="text" id="exclude-words" placeholder="e.g., the, and">
        <br>
        <button id="apply-filters">Apply Filters</button>
    </div>
    <div id="overlay"></div>
    <div id="word-cloud"></div>
    <div id="popup">
        <span id="popup-close">Ã—</span>
        <h2 id="popup-title"></h2>
        <p id="popup-content"></p>
    </div>

    <script>
        // Fetch Bible JSON from GitHub
        async function fetchBibleData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/thiagobodruk/bible/master/json/en_kjv.json');
                if (!response.ok) throw new Error('Failed to fetch Bible JSON');
                return await response.json();
            } catch (e) {
                throw new Error('Could not load Bible data: ' + e.message);
            }
        }

        // Populate book dropdown
        async function populateBookDropdown() {
            const bibleData = await fetchBibleData();
            const bookSelect = document.getElementById('book-select');
            bibleData.forEach(book => {
                const option = document.createElement('option');
                option.value = book.book;
                option.textContent = book.book;
                bookSelect.appendChild(option);
            });
            return bibleData; // Return data for further use
        }

        // Process Bible JSON into word frequencies with filters
        function processBibleData(bibleData, selectedBook, includeWords, excludeWords) {
            // Default stop words
            const defaultStopWords = new Set([
                "the", "and", "that", "shall", "for", "unto", "his", "they", "him",
                "in", "of", "to", "he", "was", "is", "it", "with", "be", "not",
                "all", "have", "thou", "thy", "ye", "from", "upon", "which",
                "but", "as", "are", "were", "their", "this", "my", "me", "by",
                "said", "will", "out", "on", "into", "when", "then", "them",
                "her", "there", "at", "had", "you", "do", "so", "an", "or"
            ]);

            // Custom filters
            const includeSet = includeWords ? new Set(includeWords.split(',').map(w => w.trim().toLowerCase())) : null;
            const excludeSet = excludeWords ? new Set(excludeWords.split(',').map(w => w.trim().toLowerCase())) : defaultStopWords;

            let text = "";
            bibleData.forEach(book => {
                if (selectedBook === 'all' || book.book === selectedBook) {
                    book.chapters.forEach(chapter => {
                        chapter.forEach(verse => {
                            text += verse + " ";
                        });
                    });
                }
            });

            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2 && (!excludeSet.has(word) || (includeSet && includeSet.has(word))))
                .filter(word => !includeSet || includeSet.has(word)); // If includeSet exists, only keep those words

            const wordCount = {};
            words.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });

            return Object.entries(wordCount)
                .map(([word, count]) => ({ word, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 100); // Top 100 words
        }

        // Fetch and process word data with filters
        async function fetchWordData(bibleData, selectedBook, includeWords, excludeWords) {
            return processBibleData(bibleData, selectedBook, includeWords, excludeWords);
        }

        // Display words
        async function displayWords(bibleData) {
            const wordCloud = document.getElementById('word-cloud');
            const selectedBook = document.getElementById('book-select').value;
            const includeWords = document.getElementById('include-words').value;
            const excludeWords = document.getElementById('exclude-words').value;

            try {
                const wordData = await fetchWordData(bibleData, selectedBook, includeWords, excludeWords);
                window.wordData = wordData; // Store globally for popup access
                const maxCount = Math.max(...wordData.map(w => w.count));
                const totalWords = selectedBook === 'all' ? 788258 : calculateBookWordCount(bibleData, selectedBook);

                wordCloud.innerHTML = ""; // Clear previous content
                wordData.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'word';
                    span.textContent = item.word;
                    const fontSize = (item.count / maxCount) * 60 + 10;
                    span.style.fontSize = `${fontSize}px`;
                    span.addEventListener('click', () => showPopup(item, totalWords));
                    wordCloud.appendChild(span);
                });
            } catch (e) {
                console.error(e);
                wordCloud.innerHTML = `<div id="error-message">${e.message}</div>`;
            }
        }

        // Calculate total words for a specific book
        function calculateBookWordCount(bibleData, selectedBook) {
            let text = "";
            bibleData.forEach(book => {
                if (book.book === selectedBook) {
                    book.chapters.forEach(chapter => {
                        chapter.forEach(verse => {
                            text += verse + " ";
                        });
                    });
                }
            });
            return text.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).length;
        }

        // Show popup with stats
        function showPopup(item, totalWords) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('popup-title');
            const content = document.getElementById('popup-content');

            title.textContent = item.word;
            content.innerHTML = `
                <strong>Occurrences:</strong> ${item.count} times<br>
                <strong>Percentage:</strong> ${(item.count / totalWords * 100).toFixed(2)}%<br>
                <strong>Rank:</strong> ${window.wordData.findIndex(w => w.word === item.word) + 1}
            `;

            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        // Close popup
        document.getElementById('popup-close').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });

        // Initialize and set up filters
        async function initialize() {
            const bibleData = await populateBookDropdown();
            displayWords(bibleData); // Initial display with all books
            document.getElementById('apply-filters').addEventListener('click', () => displayWords(bibleData));
        }

        initialize();
    </script>
</body>
</html>
