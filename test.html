<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Most Used Words in the Bible</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: auto;
        }
        #word-cloud {
            text-align: center;
            max-width: 80%;
            flex-wrap: wrap;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .word {
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s;
            padding: 5px;
        }
        .word:hover {
            transform: scale(1.1);
            color: #007BFF;
        }
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            text-align: left;
        }
        #popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #333;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="word-cloud"></div>
    <div id="popup">
        <span id="popup-close">Ã—</span>
        <h2 id="popup-title"></h2>
        <p id="popup-content"></p>
    </div>

    <script>
        // Precomputed fallback data in case all APIs fail
        const fallbackData = [
            {"word": "lord", "count": 7759},
            {"word": "god", "count": 3977},
            {"word": "man", "count": 2764},
            {"word": "israel", "count": 2575},
            {"word": "people", "count": 2143}
        ];

        // API fetch functions with redundancy
        const apiSources = [
            {
                name: "Holy Bible API",
                async fetchText() {
                    const books = await (await fetch('https://bible-go-api.rkeplin.com/v1/books')).json();
                    let text = "";
                    for (const book of books.slice(0, 2)) { // Limit for demo
                        const chapters = await (await fetch(`https://bible-go-api.rkeplin.com/v1/books/${book.id}/chapters?translation=KJV`)).json();
                        for (const chapter of chapters) {
                            const verses = await (await fetch(`https://bible-go-api.rkeplin.com/v1/books/${book.id}/chapters/${chapter.id}?translation=KJV`)).json();
                            verses.forEach(verse => text += verse.text + " ");
                        }
                    }
                    return text;
                }
            },
            {
                name: "Bible SuperSearch API",
                async fetchText() {
                    const books = ["Gen", "Exod"]; // Limit for demo
                    let text = "";
                    for (const book of books) {
                        const data = await (await fetch(`https://api.biblesupersearch.com/api?bible=kjv&reference=${book}`)).json();
                        if (data.results) {
                            data.results.forEach(passage => {
                                Object.values(passage.verses.kjv).forEach(chapter => {
                                    Object.values(chapter).forEach(verse => text += verse.text + " ");
                                });
                            });
                        }
                    }
                    return text;
                }
            },
            {
                name: "Bible API",
                async fetchText() {
                    const response = await fetch('https://bibleapi.co/api/verses/kjv'); // Requires full Bible fetch, simplified for demo
                    const data = await response.json();
                    let text = "";
                    data.forEach(verse => text += verse.text + " ");
                    return text;
                }
            }
        ];

        // Process text into word frequencies
        function processText(text) {
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2);
            const wordCount = {};
            words.forEach(word => wordCount[word] = (wordCount[word] || 0) + 1);
            return Object.entries(wordCount)
                .map(([word, count]) => ({ word, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
        }

        // Fetch word data with redundancy
        async function fetchWordData() {
            // Try precomputed JSON first
            try {
                const response = await fetch('word-frequencies.json');
                if (response.ok) return await response.json();
            } catch (e) {
                console.log("Precomputed JSON not found, trying APIs...");
            }

            // Try each API in sequence
            for (const api of apiSources) {
                try {
                    console.log(`Attempting ${api.name}...`);
                    const text = await api.fetchText();
                    if (text) return processText(text);
                } catch (e) {
                    console.error(`${api.name} failed:`, e);
                }
            }

            // Fallback to static data if all APIs fail
            console.log("All APIs failed, using fallback data...");
            return fallbackData;
        }

        // Display words
        async function displayWords() {
            const wordData = await fetchWordData();
            window.wordData = wordData; // Store globally for popup access
            const wordCloud = document.getElementById('word-cloud');
            const maxCount = Math.max(...wordData.map(w => w.count));
            const totalWords = wordData.reduce((sum, item) => sum + item.count, 0); // Adjust for full Bible later

            wordCloud.innerHTML = ""; // Clear previous content
            wordData.forEach(item => {
                const span = document.createElement('span');
                span.className = 'word';
                span.textContent = item.word;
                const fontSize = (item.count / maxCount) * 60 + 10;
                span.style.fontSize = `${fontSize}px`;
                span.addEventListener('click', () => showPopup(item, totalWords));
                wordCloud.appendChild(span);
            });
        }

        // Show popup with stats
        function showPopup(item, totalWords) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('popup-title');
            const content = document.getElementById('popup-content');

            title.textContent = item.word;
            content.innerHTML = `
                <strong>Occurrences:</strong> ${item.count} times<br>
                <strong>Percentage:</strong> ${(item.count / totalWords * 100).toFixed(2)}% (sample data)<br>
                <strong>Rank:</strong> ${window.wordData.findIndex(w => w.word === item.word) + 1}
            `;

            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        // Close popup
        document.getElementById('popup-close').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });

        // Load words on page load
        displayWords();
    </script>
</body>
</html>
